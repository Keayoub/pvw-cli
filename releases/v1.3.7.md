# Version 1.3.7 - CSV Import Integration & Bidirectional Sync

**Release Date**: 2025-11-18  
**Type**: Feature Enhancement

## ‚ú® New Features

### 1. Seamless CSV Import - Direct Purview UI Export Support

The CLI now natively supports CSV files exported from the Microsoft Purview UI without any manual conversion or format specification.

#### What's New

- **Transparent Format Detection**: Automatically adapts to any CSV format (UI export or CLI format)
- **Direct API Upload**: UI-exported CSVs are uploaded directly to the API via multipart/form-data
- **Zero Configuration**: No flags, no format specification - just works
- **Backward Compatible**: Existing CLI CSV format continues to work seamlessly

#### Implementation Details

**Files Modified**:
- `purviewcli/cli/glossary.py` - Added file upload support to `import-terms` command
- `purviewcli/cli/unified_catalog.py` - Enhanced `import-csv` command with UI format parsing
- `purviewcli/client/_glossary.py` - Added multipart/form-data support
- `purviewcli/client/endpoint.py` - Added files parameter handling
- `purviewcli/client/sync_client.py` - Implemented multipart upload logic

#### Key Changes

**Classic Glossary Import** (`pvw glossary import-terms`):
- Detects Purview UI CSV format (columns: Name, Definition, Acronym, Experts, Stewards, Resources, etc.)
- Uploads directly to `/datamap/api/atlas/v2/glossary/{glossaryGuid}/terms/import`
- API automatically handles:
  - Email ‚Üí Entra Object ID (GUID) conversion
  - Parent term hierarchy resolution
  - Related terms and synonyms linking
  - Term template assignment

**Unified Catalog Import** (`pvw uc term import-csv`):
- Parses UI format with intelligent field mapping:
  - `Name` ‚Üí `name`
  - `Definition` ‚Üí `description`
  - `Acronym` ‚Üí `acronyms`
  - `Resources` (name:url) ‚Üí structured resource objects
  - `Experts`/`Stewards` (email:info) ‚Üí `owner_ids`
- Warns about UC API limitations (hierarchy, related terms, templates not supported)
- Creates individual terms via REST API

#### API Fix

**Fixed**: `includeTermHierarchy` parameter now defaults to `True`
- **Issue**: API returned HTTP 400 error requiring `includeTermHierarchy=True`
- **Solution**: Changed default from `False` to `True` in `_glossary.py`
- **Impact**: Import commands now work without additional flags

#### Usage Examples

```powershell
# Import classic glossary terms from Purview UI export
pvw glossary import-terms --csv-file "Sample-2025_11_18-09_39_56.csv" --glossary-guid <guid>

# Import UC terms from Purview UI export
pvw uc term import-csv --csv-file "HR-2025_11_18-09_38_57.csv" --domain-id <guid>

# Both commands work with existing CLI CSV format too
pvw glossary import-terms --csv-file "cli-format.csv" --glossary-guid <guid>
```

### 2. Bidirectional Glossary Sync - Classic ‚Üî Unified Catalog

Added inverse sync capability to migrate terms from classic glossaries to Unified Catalog domains.

#### New Command: `pvw glossary sync-uc`

Complements the existing `pvw uc term sync-classic` command, providing full bidirectional synchronization.

**Direction**: Classic Glossary ‚Üí Unified Catalog

**Features**:
- Fetches terms from classic glossary
- Auto-creates UC domain with glossary name (optional)
- Maps classic term fields to UC structure:
  - `longDescription`/`shortDescription` ‚Üí `description`
  - `abbreviation` ‚Üí `acronyms`
  - `status` ‚Üí `status`
- Supports dry-run mode for preview
- Updates existing terms (optional)
- Detailed progress tracking and summary

**Usage Examples**:

```powershell
# Sync classic glossary to UC (auto-create domain)
pvw glossary sync-uc --glossary-guid <guid> --create-domain

# Sync to specific domain
pvw glossary sync-uc --glossary-guid <guid> --domain-id <domain-id>

# Preview without changes
pvw glossary sync-uc --glossary-guid <guid> --dry-run

# Update existing UC terms
pvw glossary sync-uc --glossary-guid <guid> --update-existing

# Combined: create domain and update existing
pvw glossary sync-uc --glossary-guid <guid> --create-domain --update-existing
```

#### Sync Commands Summary

| Command | Direction | Use Case |
|---------|-----------|----------|
| `pvw uc term sync-classic` | UC ‚Üí Classic | Publish business metadata to traditional glossaries |
| `pvw glossary sync-uc` | Classic ‚Üí UC | Migrate classic terms to governance domains |

## üîß Technical Improvements

### HTTP Client Enhancements

**Multipart/Form-Data Support**:
- Added `files` parameter to `make_request()` in `sync_client.py`
- Conditional `Content-Type` header handling:
  - Omitted for multipart uploads (requests sets automatically)
  - Set to `application/json` for regular API calls
- Updated retry logic to include files parameter

### CSV Format Detection

**Intelligent Parsing**:
- Checks for "Name" and "Definition" columns (UI format)
- Falls back to "name" and "description" (CLI format)
- No user-visible format detection messages
- Completely transparent operation

### Error Handling

**Improved Validation**:
- Detects email addresses in owner fields
- Warns when UC API requires GUIDs instead of emails
- Provides clear error messages for missing required parameters

## üìö Documentation

### Updated Instructions

**Copilot Instructions** (`.github/copilot-instructions.md`):
- Added Windows Console Compatibility section
- Documented common failure causes (uncommitted work, Unicode errors, etc.)
- PowerShell JSON parsing guidelines
- Rate limiting best practices

### CSV Format Reference

**UI Export Format** (Classic Glossary):
```csv
Name,Definition,Status,Acronym,Synonyms,Related Terms,Resources,Experts,Stewards,Parent Term Name
```

**UI Export Format** (UC Domain):
```csv
Name,Definition,Status,Acronym,Resources,Experts,Stewards
```

**CLI Format** (Both):
```csv
name,description,status,acronyms,owner_ids,resource_name,resource_url
```

## üéØ Use Cases

### Scenario 1: Export-Modify-Import Workflow
1. Export terms from Purview UI to CSV
2. Modify terms in Excel/CSV editor
3. Import modified CSV directly without conversion
4. ‚úÖ Changes applied seamlessly

### Scenario 2: Classic to UC Migration
1. Export classic glossary via Purview UI
2. Review and update in spreadsheet
3. Import to UC domain: `pvw uc term import-csv --csv-file export.csv --domain-id <id>`
4. ‚úÖ Terms migrated to governance domain

### Scenario 3: Bidirectional Sync
1. Maintain classic glossary for legacy systems
2. Sync to UC: `pvw glossary sync-uc --glossary-guid <guid> --create-domain`
3. Update UC terms via governance workflows
4. Sync back: `pvw uc term sync-classic --domain-id <id> --glossary-guid <guid>`
5. ‚úÖ Both systems stay in sync

### Scenario 4: Bulk Import from UI Templates
1. Download Purview UI CSV template
2. Populate with business terms in Excel
3. Import directly: `pvw glossary import-terms --csv-file template.csv --glossary-guid <guid>`
4. ‚úÖ Terms created with full metadata (hierarchy, relationships, etc.)

## üîÑ API Compatibility

### Classic Glossary API
- **Endpoint**: `POST /datamap/api/atlas/v2/glossary/{glossaryGuid}/terms/import`
- **Content-Type**: `multipart/form-data`
- **Format**: UI CSV format
- **Features**: Full support (hierarchy, relationships, templates)

### Unified Catalog API
- **Endpoint**: `POST /api/governance/glossaries/{glossaryId}/terms`
- **Content-Type**: `application/json`
- **Format**: Individual term objects
- **Limitations**: No hierarchy, related terms, or templates

## üöÄ Performance

- **Multipart Upload**: Efficient for large CSV files
- **Parallel Processing**: Future enhancement opportunity
- **Rate Limiting**: Built into bulk operations (200ms delay)

## üêõ Bug Fixes

- Fixed `includeTermHierarchy` parameter default (False ‚Üí True)
- Removed Unicode emoji from CLI output (Windows compatibility)
- Fixed import path for `UnifiedCatalogClient` in glossary.py

## üì¶ Migration Notes

### From Previous Versions

No breaking changes. All existing commands and CSV formats continue to work.

### New Capabilities Available

- Import Purview UI exports without conversion
- Sync classic glossaries to UC domains
- Bidirectional sync workflows

## üîÆ Future Enhancements

Potential improvements for future releases:
- Parallel term creation for faster imports
- Conflict resolution strategies for sync
- Incremental sync (only changed terms)
- Export commands to generate UI-compatible CSVs
- Relationship preservation in UC sync (when API supports)

## üìä Statistics

- **Files Modified**: 5
- **New Commands**: 1 (`pvw glossary sync-uc`)
- **Enhanced Commands**: 2 (`import-terms`, `import-csv`)
- **Lines of Code Added**: ~250
- **Test Coverage**: Manual validation with sample CSVs

## üôè Acknowledgments

This release focuses on user experience improvements based on real-world usage patterns:
- Seamless integration with Purview UI workflows
- Elimination of manual CSV format conversion
- Bidirectional sync for hybrid scenarios

---

**Full Changelog**: https://github.com/Keayoub/pvw-cli/compare/v1.3.5...v1.3.6
