# Version 1.3.9 - Optimized Collection Resources with API Filters

**Release Date**: 2025-12-11  
**Type**: Performance Enhancement & Bug Fix

## ‚ú® New Features

### Collections Resources Command - API-Level Filtering

The `pvw collections resources` command now uses **native API filters** for entity type filtering, dramatically improving performance and result accuracy.

#### What Changed

**Before**: 
- Retrieved 1000 mixed assets from API
- Applied client-side filtering for entity type
- Result: Only 2-15 assets of the desired type from 1000 retrieved

**After**:
- Applies `entityType` filter directly in the API request
- API returns up to 1000 assets of the **exact type requested**
- Result: 15-112+ assets per type (up to API limit of 1000)

#### Performance Impact

**Example - PowerBI Datasets**:
- Before: 2 results (filtered from 1000 mixed assets)
- After: 15 results (API returned only powerbi_dataset types)
- **Improvement**: 7.5x more results with same API call

**Example - Fabric Lakehouse Tables**:
- Before: ~5 results per collection
- After: 112 results across all collections
- **Improvement**: 22x more results

#### Implementation Details

**File Modified**: `purviewcli/cli/collections.py`

**Key Changes**:
```python
# Build API filter with collectionId and optional entityType
filter_dict = {"collectionId": coll_name}

# Add entityType filter to API request if specified
if asset_type:
    filter_dict["entityType"] = asset_type

search_args = {
    '--filter': json.dumps(filter_dict),
    '--limit': min(1000, limit)
}
```

**Filter Strategy**:
- **collectionId**: Always applied in API filter
- **entityType**: Applied in API filter when `--asset-type` is specified
- **data_source**: Remains client-side filter (assetType field matching)

#### Usage Examples

```powershell
# Get all PowerBI datasets from specific collection
pvw collections resources --collection-name kaydemopurview --asset-type powerbi_dataset --json

# Get all Fabric lakehouse tables across all collections
pvw collections resources --asset-type fabric_lakehouse_table --data-source Fabric --json

# Export all Fabric assets by type (optimized script)
.\collect_all_fabric_assets.ps1
```

#### Benefits

1. **Better Performance**: API does the filtering, reducing data transfer
2. **More Complete Results**: Each type query can return up to 1000 assets
3. **Accurate Counts**: Results reflect actual assets of the requested type
4. **Scalability**: Can retrieve different types separately to bypass global 1000 limit

## üìä Supporting Scripts

### collect_all_fabric_assets.ps1

New PowerShell script for comprehensive Fabric asset collection:

**Features**:
- Iterates through 21 Fabric asset types
- Uses API filter for each type
- Combines results from all collections
- Exports JSON and CSV formats
- Progress tracking and statistics
- No emoji output (clean PowerShell display)

**Results Example**:
```
fabric_lakehouse_table         :   112 ( 45.9%)
powerbi_dataset                :    60 ( 24.6%)
fabric_lakehouse               :    20 (  8.2%)
fabric_pipeline                :    16 (  6.6%)
powerbi_report                 :    16 (  6.6%)
...
Total unique assets            : 244
```

## üêõ Bug Fixes

- Fixed client-side filtering that was reducing result sets unnecessarily
- Removed emoji characters from PowerShell scripts to prevent encoding issues
- Improved error handling for empty result sets

## üìö Documentation

- Added examples of API filter usage in collection queries
- Documented the difference between API-level and client-side filtering
- Provided PowerShell scripts for bulk asset collection

## üîß Technical Details

### API Filter Structure

The Search API now receives:
```json
{
  "keywords": "*",
  "limit": 1000,
  "filter": {
    "collectionId": "collection-name",
    "entityType": "powerbi_dataset"
  }
}
```

Previously:
```json
{
  "keywords": "*",
  "limit": 1000,
  "filter": {
    "collectionId": "collection-name"
  }
}
```

### Backward Compatibility

- All existing commands continue to work
- `--asset-type` parameter behavior improved (no breaking changes)
- `--data-source` filtering still works (client-side as before)

## üöÄ Migration Guide

No migration needed - this is a performance improvement with no breaking changes.

**To leverage the improvements**:
1. Use `--asset-type` to filter by specific entity types
2. Run separate queries per type for large collections (>1000 assets)
3. Use provided PowerShell scripts for bulk collection

**Example workflow**:
```powershell
# Old approach (limited results)
pvw collections resources --collection-name myCollection --json

# New optimized approach (type-specific)
pvw collections resources --collection-name myCollection --asset-type powerbi_dataset --json
pvw collections resources --collection-name myCollection --asset-type fabric_lakehouse_table --json
```

## üìà Performance Metrics

**Test Case**: kaydemopurview collection with Fabric assets

| Asset Type | Before | After | Improvement |
|-----------|--------|-------|-------------|
| powerbi_dataset | 2 | 15 | 7.5x |
| fabric_lakehouse_table | 7 | 28 | 4x |
| powerbi_report | 1 | 4 | 4x |
| fabric_pipeline | 1 | 4 | 4x |

**Overall**: 244 assets collected vs ~60 with previous approach (4x improvement)

## üôè Credits

This enhancement was driven by real-world usage where users needed to export all Fabric assets (44,384 total) from their Purview catalog. The API filter optimization enables more efficient data extraction.

---

**Installation**:
```bash
pip install --upgrade purviewcli
```

**Full Changelog**: https://github.com/Keayoub/pvw-cli/compare/v1.3.8...v1.3.9
