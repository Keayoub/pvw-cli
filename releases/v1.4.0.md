# Version 1.4.0 - Enhanced Bulk Update with Custom Metadata Support

**Release Date**: 2025-12-18  
**Type**: Major Feature Enhancement

## ‚ú® New Features

### Bulk Update CSV - Debug Mode
Added `--debug` option to `pvw entity bulk-update-csv` command for detailed diagnostic logging.

**What It Does**:
- Shows CSV columns and row count
- Displays the first row of data
- Shows detection mode (GUID vs typeName)
- Prints complete JSON payloads sent to API
- Displays API responses
- Shows detailed exception messages

**Usage**:
```bash
pvw entity bulk-update-csv --csv-file data.csv --debug
pvw entity bulk-update-csv --csv-file data.csv --dry-run --debug
```

**Benefits**:
- Easier troubleshooting of bulk update operations
- Visibility into what data is sent to Purview API
- Quick identification of mapping issues
- Better understanding of attribute transformations

---

### Custom Metadata Support with Nested Attributes

Complete support for custom metadata in bulk update operations with three attribute types:

#### 1. Simple Custom Attributes
Any column name is added directly to entity attributes:
```csv
guid,displayName,myCustomField,anotherField
abc-123,Asset Name,Custom Value,Another Value
```

#### 2. Business Metadata (Nested with Dot Notation)
Use dot notation to create nested structures:
```csv
guid,businessMetadata.department,businessMetadata.owner
abc-123,Sales,owner@company.com
```
Results in:
```json
{
  "attributes": {
    "businessMetadata": {
      "department": "Sales",
      "owner": "owner@company.com"
    }
  }
}
```

#### 3. Custom Attributes Section
Dedicated section for custom attributes:
```csv
guid,customAttributes.classification,customAttributes.sensitivity
abc-123,CONFIDENTIAL,HIGH
```
Results in:
```json
{
  "attributes": {
    "customAttributes": {
      "classification": "CONFIDENTIAL",
      "sensitivity": "HIGH"
    }
  }
}
```

---

### Enhanced map_flat_entity_to_purview_entity Function

**File Modified**: `purviewcli/client/_entity.py`

**Key Improvements**:
- Support for nested attributes via dot notation (e.g., `section.attribute`)
- Automatic handling of special sections (businessMetadata, customAttributes)
- GUID extraction and placement at entity root level
- Optional debug mode for attribute mapping visualization
- Smart handling of NaN/None values

**Example Transformations**:

Input CSV:
```csv
guid,displayName,businessMetadata.dept,customAttributes.class
abc,Asset,Sales,PII
```

Output JSON:
```json
{
  "guid": "abc",
  "typeName": null,
  "attributes": {
    "displayName": "Asset",
    "businessMetadata": {
      "dept": "Sales"
    },
    "customAttributes": {
      "class": "PII"
    }
  }
}
```

---

## üìö Documentation

### New Guides Created

1. **CUSTOM_METADATA_HOWTO.md** (115 KB)
   - Complete practical guide with step-by-step examples
   - 4 CSV formats supported with examples
   - Workflow recommendations
   - 4 detailed use cases
   - Troubleshooting section
   - Verification procedures

2. **custom-metadata-management.md** (20 KB)
   - Technical documentation
   - API patterns and best practices
   - Notation guide
   - Limitations and notes
   - Comprehensive examples

3. **custom-metadata-quickref.md** (3 KB)
   - Quick reference cheat sheet
   - Essential commands
   - Format examples
   - Common issues solutions

4. **bulk-update-custom-attributes.md** (Updated)
   - Original guide enhanced with debug option
   - Complete option reference
   - Error handling patterns

5. **bulk-update-example-guide.md** (18 KB)
   - Detailed explanation of example CSV
   - Line-by-line breakdown
   - Customization instructions
   - Validation checklist

6. **csv-example-visualization.md** (17 KB)
   - Visual representation of all 10 entities
   - Table format for easy reference
   - Statistical summary
   - Pattern explanations

7. **example-csv-quickstart.md** (5 KB)
   - Fast start guide
   - Usage examples
   - Adaptation instructions

8. **example-csv-reference.md** (3 KB)
   - Compact reference
   - File structure
   - Quick commands

9. **example-csv-summary.md** (8 KB)
   - Overview and summary
   - Before/after examples
   - Modification patterns

10. **README_CUSTOM_METADATA.md** (5 KB)
    - Entry point documentation
    - Links to all resources
    - Quick start section

---

## üìÅ Example Files

### CSV Examples Created

1. **bulk_update_example_complete.csv** (10 entities)
   - Complete example with all attribute types
   - Realistic business scenarios:
     - Customer Master Data (Salesforce, PII)
     - Product Catalog (SAP-ERP, INTERNAL)
     - Sales Orders History (SAP-ERP, CONFIDENTIAL)
     - Marketing Campaign Metrics (Salesforce, INTERNAL)
     - Employee Directory (Workday, RESTRICTED)
     - Financial Reports (Oracle, HIGHLY_CONFIDENTIAL)
     - Inventory Levels (SAP-ERP, INTERNAL)
     - Website Analytics (Google-Analytics, PUBLIC)
     - Social Media Metrics (Hootsuite, INTERNAL)
     - Supply Chain Events (Kinaxis, INTERNAL)
   - 13 columns including GUID, simple attributes, business metadata, custom attributes
   - Ready to use as template

2. **simple_custom_attrs.csv**
   - Basic example with simple custom attributes
   - 2 entities for quick testing

3. **example_custom_metadata.csv** (Updated)
   - Business metadata examples
   - 5 entities with department, cost center, classification

4. **test_bulk_update_custom_attrs.csv**
   - Mix of all attribute types
   - Used by unit tests

---

## üß™ Testing

### New Test Suite

**File**: `tests/test_bulk_update_custom_attributes.py`

**7 Test Scenarios**:
1. ‚úÖ Simple Attributes - Basic attribute mapping
2. ‚úÖ Custom Attributes - Custom field handling
3. ‚úÖ Business Metadata (Nested) - Dot notation to nested structure
4. ‚úÖ Custom Attributes Section - Dedicated section handling
5. ‚úÖ Mixed Attributes - All types combined
6. ‚úÖ Mapping with GUID - Partial update mode
7. ‚úÖ CSV Processing - Complete workflow simulation

**All tests passing** ‚úÖ

**Test Coverage**:
- Attribute mapping accuracy
- Nested structure creation
- GUID handling
- NaN/None value filtering
- Multiple attribute types in single entity
- CSV-to-JSON transformation
- Debug mode functionality

---

## üéØ Use Cases Enabled

### 1. Data Classification
```csv
guid,customAttributes.dataClassification,customAttributes.sensitivityLevel
abc,PII,HIGH
def,CONFIDENTIAL,MEDIUM
```

### 2. Governance Metadata
```csv
guid,businessMetadata.department,businessMetadata.dataOwner,customAttributes.retentionDays
abc,Sales,team@company.com,2555
```

### 3. Source System Tracking
```csv
guid,sourceSystem,refreshFrequency,lastRefreshDate
abc,SAP-ERP,DAILY,2025-12-18
```

### 4. Multi-dimensional Enrichment
```csv
guid,displayName,customField,businessMetadata.dept,customAttributes.class
abc,Asset,Value,Sales,PII
```

---

## üîß Technical Details

### Files Modified

1. **purviewcli/cli/entity.py** (Line 1691-1928)
   - Added `--debug` option to `bulk_update_csv` command
   - Enhanced debug logging throughout the function
   - Added CSV structure logging
   - Added payload and API response logging
   - Improved error message detail

2. **purviewcli/client/_entity.py** (Line 22-118)
   - Rewrote `map_flat_entity_to_purview_entity` function
   - Added support for dot notation parsing
   - Implemented nested structure building
   - Added businessMetadata special handling
   - Added customAttributes special handling
   - Added optional debug parameter
   - Improved GUID extraction and placement
   - Enhanced NaN/None filtering

### Implementation Patterns

**Dot Notation Parsing**:
```python
if "." in k:
    parts = k.split(".", 1)
    parent_key = parts[0]
    child_key = parts[1]
    
    if parent_key == "businessMetadata":
        if "businessMetadata" not in attrs:
            attrs["businessMetadata"] = {}
        attrs["businessMetadata"][child_key] = v
```

**GUID Handling**:
```python
# Extract GUID from data (not in attributes)
guid = data.pop("guid", None)

# ... build attributes ...

# Add GUID at entity root level
if guid is not None:
    result["guid"] = str(guid)
```

---

## üìä Statistics

- **Documentation**: 10 new guide documents (Total: ~200 KB)
- **Examples**: 4 CSV example files
- **Tests**: 7 comprehensive test scenarios
- **Code Changes**: 2 files modified, ~150 lines added/modified
- **Attribute Types Supported**: 3 (Simple, Business Metadata, Custom Attributes)
- **Example Entities**: 10 realistic business scenarios

---

## üéì Learning Resources

### Quick Start Path
1. Read `README_CUSTOM_METADATA.md` - Overview
2. Try `example-csv-quickstart.md` - Fast hands-on
3. Use `bulk_update_example_complete.csv` - Real example
4. Refer to `custom-metadata-quickref.md` - Quick reference

### Deep Dive Path
1. Study `CUSTOM_METADATA_HOWTO.md` - Complete guide
2. Review `custom-metadata-management.md` - Technical details
3. Examine `bulk-update-example-guide.md` - Detailed examples
4. Check `csv-example-visualization.md` - Visual reference

### Troubleshooting Path
1. Enable `--debug` flag
2. Check `CUSTOM_METADATA_HOWTO.md` troubleshooting section
3. Review test files for patterns
4. Examine example CSVs for correct format

---

## ‚ö†Ô∏è Breaking Changes

None. All changes are backward compatible.

---

## üêõ Bug Fixes

- Fixed attribute mapping to properly handle nested structures
- Fixed GUID placement in entity payload
- Fixed NaN/None value handling in CSV processing
- Improved error messages for failed bulk operations

---

## üìù Notes

### Recommendations

1. **Always test with --dry-run first**
   ```bash
   pvw entity bulk-update-csv --csv-file data.csv --dry-run --debug
   ```

2. **Use --error-csv to capture failures**
   ```bash
   pvw entity bulk-update-csv --csv-file data.csv --error-csv errors.csv
   ```

3. **Verify attribute names match Purview schema**
   - Attribute names are case-sensitive
   - Business metadata templates must exist
   - Check with `--debug` to see exact names sent

4. **Batch size adjustment for large files**
   ```bash
   pvw entity bulk-update-csv --csv-file large.csv --batch-size 25
   ```

### Limitations

- CSV values treated as strings (server handles type conversion)
- Entity size limit: 2 MB per entity
- NaN/None/empty values are ignored
- Business metadata requires existing templates in Purview

---

## üöÄ Migration Guide

### From Previous Versions

**No migration required**. The new features are additive.

### To Use New Features

**Before** (v1.3.x):
```csv
guid,displayName,description
abc,Asset,Description
```

**After** (v1.4.0):
```csv
guid,displayName,description,businessMetadata.dept,customAttributes.class
abc,Asset,Description,Sales,PII
```

The old format still works perfectly. New columns enable additional capabilities.

---

## üéâ Summary

Version 1.4.0 represents a major enhancement to bulk update capabilities:

- ‚úÖ Debug mode for troubleshooting
- ‚úÖ Complete custom metadata support
- ‚úÖ Nested attribute structures via dot notation
- ‚úÖ Comprehensive documentation (10 guides)
- ‚úÖ Real-world examples (10 entities)
- ‚úÖ Full test coverage (7 scenarios)
- ‚úÖ Backward compatible

**Ready for production use** with enhanced metadata management capabilities.

---

## üì¶ Installation

```bash
pip install --upgrade pvw-cli==1.4.0
```

Or from source:
```bash
pip install -e .
```

---

## üîó Resources

- **GitHub**: https://github.com/Keayoub/pvw-cli
- **Documentation**: `doc/guides/`
- **Examples**: `samples/csv/`
- **Tests**: `tests/`

---

## üëè Contributors

- AYOUB KEBAILI (@Keayoub)

---

## üìÖ Next Steps

Planned for future releases:
- Support for classifications in bulk update
- Support for relationships in bulk update
- Automatic CSV validation before execution
- Retry mechanism for failed operations
- Progress bar for large bulk operations

---

**Full Changelog**: https://github.com/Keayoub/pvw-cli/compare/v1.3.12...v1.4.0
