# Release v1.8.5 - Entity Collection Assignment & Bug Fixes

**Release Date:** February 20, 2026  
**Status:** âœ… Production Ready  
**Previous Release:** [v1.8.3](v1.8.3.md) (February 6, 2026)

---

## ğŸ¯ Overview

v1.8.5 adds native support for assigning entities directly to collections during creation, eliminating the need for separate move operations. This release also fixes a critical bug in the `move-to-collection` command and enhances entity example files with comprehensive metadata fields.

### Key Statistics

- **New Feature:** Collection assignment during entity creation
- **Bug Fixed:** AttributeError in `pvw entity move-to-collection` command
- **Enhanced Examples:** Updated entity JSON samples with contacts, labels, and metadata
- **API Compatibility:** Confirmed support for `collectionId` parameter in API 2023-09-01+

---

## âœ¨ What's New

### ğŸš€ Collection Assignment During Entity Creation

**Problem Solved:**
Previously, entities could only be created in the root collection, requiring a separate `move-to-collection` operation. This two-step process was inefficient for bulk operations.

**Solution:**
v1.8.5 adds `--collection-id` parameter to both `create` and `bulk-create` commands, allowing direct assignment to target collections.

**New Commands:**

```powershell
# Create single entity directly in a collection
pvw entity create --payload-file entity.json --collection-id yfwy2c

# Create multiple entities in bulk directly in a collection
pvw entity bulk-create --payload-file entities.json --collection-id yfwy2c
```

**Technical Implementation:**
- Added `--collection-id` CLI option to `entity create` and `entity bulk-create` commands
- Client methods now pass `collectionId` as query parameter to API endpoints
- Compatible with API versions 2023-09-01, 2024-03-01-preview, and later
- Follows Microsoft official documentation for bulk entity operations

**API Endpoint:**
```http
POST {endpoint}/datamap/api/atlas/v2/entity/bulk?api-version=2023-09-01&collectionId={collectionId}
```

**Benefits:**
- âœ… One-step entity creation with collection assignment
- âœ… Eliminates need for separate move operations
- âœ… Faster bulk imports
- âœ… Cleaner automation scripts

**Backward Compatibility:**
âœ… **No Breaking Changes:** The `--collection-id` parameter is optional. If omitted, entities are created in the root collection (default behavior).

---

### ğŸ› Bug Fixes

#### Fixed: AttributeError in `move-to-collection` Command

**Issue:**
```
[X] Error executing entity move-to-collection: 'Entity' object has no attribute 'entityMoveEntitiesToCollection'
```

**Root Cause:**
Method name mismatch between CLI command and client implementation:
- CLI was calling: `entityMoveEntitiesToCollection()`
- Client had: `entityMoveToCollection()`

**Fix:**
Updated CLI command to call the correct method name `entityMoveToCollection()`.

**Files Changed:**
- `purviewcli/cli/entity.py` - Line 1511 (corrected method call)

**Usage (Now Fixed):**
```powershell
# Move entities to a collection
pvw entity move-to-collection --payload-file move_payload.json
```

**Payload Format:**
```json
{
  "entityGuids": ["guid1", "guid2", "guid3"],
  "collectionId": "yfwy2c"
}
```

---

### ğŸ“„ Enhanced Entity Example Files

**Problem Solved:**
Example entity JSON files had minimal fields, not reflecting real-world usage with contacts, labels, and metadata.

**Solution:**
Updated sample files with comprehensive fields based on Microsoft Purview API documentation.

**Enhanced Fields Added:**
- **`contacts`**: Owner and Expert contacts with GUIDs and info
- **`labels`**: Tags for entity categorization (e.g., "Production", "Sensitive")
- **`createdBy`** / **`updatedBy`**: User attribution for audit trail
- **`version`**: Entity version control
- **`owner`**, **`createTime`**, **`modifiedTime`**: Additional attributes

**Updated Files:**
- `samples/json/entity/entity.json`
- `samples/json/entity/entities.json`

**Example (New Format):**
```json
{
  "entities": [
    {
      "typeName": "azure_sql_table",
      "status": "ACTIVE",
      "attributes": {
        "qualifiedName": "mssql://sqlsvr.database.windows.net/sqldb/Schema/Table01",
        "name": "Table01",
        "description": "Table01 is a custom entity.",
        "objectType": "U ",
        "owner": "DataTeam",
        "createTime": 0,
        "modifiedTime": 0
      },
      "contacts": {
        "Owner": [
          {
            "id": "30435ff9-9b96-44af-a5a9-e05c8b1ae2df",
            "info": "Data Owner Contact"
          }
        ],
        "Expert": [
          {
            "id": "30435ff9-9b96-44af-a5a9-e05c8b1ae2df",
            "info": "Technical Expert Contact"
          }
        ]
      },
      "labels": ["Production", "Sensitive"],
      "createdBy": "admin@example.com",
      "updatedBy": "admin@example.com",
      "version": 0
    }
  ]
}
```

**Important Notes:**
- Replace `30435ff9-9b96-44af-a5a9-e05c8b1ae2df` with actual Entra Object IDs (GUIDs)
- Contact IDs must be valid user/group GUIDs from Microsoft Entra ID
- Maximum 20 contacts per contact type (Owner, Expert)

---

## ğŸ”§ Technical Changes

### CLI Commands Modified

**`purviewcli/cli/entity.py`:**
- Added `--collection-id` parameter to `create()` function
- Added `--collection-id` parameter to `bulk_create()` function
- Fixed method call from `entityMoveEntitiesToCollection()` to `entityMoveToCollection()`
- Added conditional parameter passing for collection ID

### Client Methods Updated

**`purviewcli/client/_entity.py`:**
- **`entityCreateOrUpdate()`**: Now accepts `--collectionId` in args and passes to API params
- **`entityBulkCreateOrUpdate()`**: Now accepts `--collectionId` in args and passes to API params

**Implementation Pattern:**
```python
self.params = get_api_version_params("datamap")
if "--collectionId" in args:
    self.params["collectionId"] = args["--collectionId"]
```

---

## ğŸ“š Usage Examples

### Example 1: Create Entities in Specific Collection

```powershell
# Navigate to samples directory
cd samples\json\entity

# Create entities directly in collection 'yfwy2c'
pvw entity bulk-create --payload-file entities.json --collection-id yfwy2c
```

### Example 2: Single Entity with Collection Assignment

```powershell
# Create one entity in a specific collection
pvw entity create --payload-file entity.json --collection-id my-collection
```

### Example 3: Move Existing Entities

```powershell
# Create move payload
@"
{
  "entityGuids": ["e4b2c3d4-5678-90ab-cdef-1234567890ab"],
  "collectionId": "target-collection-id"
}
"@ | Out-File move_payload.json

# Execute move
pvw entity move-to-collection --payload-file move_payload.json
```

### Example 4: Workflow with Copy Script

The existing `scripts/copy_entities_to_collection.py` script already uses the correct method and continues to work seamlessly for complex entity cloning with relationships and metadata.

```powershell
# Clone entities with all metadata and relationships
python scripts/copy_entities_to_collection.py `
    --guids-file entity_guids.csv `
    --collection-id yfwy2c `
    --clone-relationships both `
    --dry-run
```

---

## ğŸ”„ Migration Guide

### For Users Coming from v1.8.3 or Earlier

**No Action Required** - This release is fully backward compatible. Existing scripts and workflows continue to work without modification.

**Optional Enhancement:**
Replace two-step create + move workflows with single-step create:

**Before (v1.8.3):**
```powershell
# Step 1: Create entities (in root collection)
pvw entity bulk-create --payload-file entities.json

# Step 2: Move to target collection
pvw entity move-to-collection --payload-file move_payload.json
```

**After (v1.8.5):**
```powershell
# Single step: Create directly in target collection
pvw entity bulk-create --payload-file entities.json --collection-id yfwy2c
```

---

## ğŸ¯ API Documentation Reference

This release implements features documented in:
- [Microsoft Purview Data Map API - Entity Bulk Create or Update](https://learn.microsoft.com/en-us/rest/api/purview/datamapdataplane/entity/bulk-create-or-update?view=rest-purview-datamapdataplane-2024-03-01-preview)
- API Versions: 2023-09-01, 2024-03-01-preview
- Query Parameter: `collectionId` (optional)

**Official Documentation Quote:**
> "The collection where entities will be moved to. Only specify a value if you need to move an entity to another collection."

---

## âš ï¸ Known Limitations

1. **Collection ID Format:**
   - Must be a valid collection identifier (e.g., 'yfwy2c')
   - Collection must exist before entity creation
   - User must have write permissions on target collection

2. **Contact GUIDs:**
   - Contact IDs must be valid Entra Object IDs (GUIDs)
   - Email addresses are NOT accepted for contacts
   - Maximum 20 contacts per contact type

3. **Business Attributes:**
   - Default behavior is 'merge' (not yet exposed in CLI)
   - Future release will add `--business-attribute-behavior` option

---

## ğŸš€ What's Next (v1.9.0 Preview)

Planned features for next release:
- `--business-attribute-behavior` parameter (ignore/replace/merge)
- Enhanced relationship cloning in copy script
- Bulk move operations with CSV input
- Collection permission validation helpers

---

## ğŸ“ Breaking Changes

**None** - This release maintains full backward compatibility.

---

## ğŸ› Bug Fixes Summary

| Issue | Status | Description |
|-------|--------|-------------|
| AttributeError in move-to-collection | âœ… Fixed | Corrected method name mismatch |
| Missing collection assignment in create | âœ… Fixed | Added --collection-id parameter |
| Minimal example files | âœ… Enhanced | Added comprehensive metadata fields |

---

## ğŸ‘¥ Contributors

- **AYOUB KEBAILI** - Feature development, bug fixes, documentation

---

## ğŸ“¦ Installation

```powershell
# Install from PyPI
pip install --upgrade pvw-cli==1.8.5

# Or install from source
git clone https://github.com/Keayoub/pvw-cli.git
cd pvw-cli
git checkout v1.8.5
pip install -e .
```

---

## ğŸ“ Support

- **Issues:** [GitHub Issues](https://github.com/Keayoub/pvw-cli/issues)
- **Documentation:** [Repository README](../README.md)
- **Email:** keayoub@msn.com

---

**Full Changelog:** [v1.8.3...v1.8.5](https://github.com/Keayoub/pvw-cli/compare/v1.8.3...v1.8.5)
