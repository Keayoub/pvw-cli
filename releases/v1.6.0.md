# Release Notes - v1.6.0

**Release Date:** January 26, 2026

## Overview
v1.6.0 introduces **comprehensive authentication error handling** and enhanced diagnostics to help users quickly resolve authentication issues. This release significantly improves the debugging experience when encountering authentication failures from various environments (VMs, VNets, remote machines).

## Major Features

### 1. Enhanced Authentication Error Handling
- **Custom Exception Classes**: Four new exception types provide specific error context:
  - `PurviewAuthenticationError`: Base exception for all authentication failures
  - `InvalidServicePrincipalError`: Triggered when service principal is not registered in Azure AD tenant
  - `AzureCredentialsError`: Generic Azure AD authentication failures
  - `NetworkError`: Network connectivity and timeout issues

### 2. Specific Error Messages with Actionable Fixes
Each authentication error now includes:
- Clear description of what went wrong
- Exact Azure AD tenant name (when available)
- **Specific PowerShell/CLI commands** to resolve the issue
- Environment variables that need to be configured

**Example Error Message:**
```
InvalidServicePrincipalError: The service principal is not registered in tenant 'contoso.onmicrosoft.com'.
Your Azure AD administrator must register the service principal.
Ask them to run: New-AzureADServicePrincipal -AppId 73c2949e-da2d-457a-9607-fcc665198967
```

### 3. Enhanced Logging
- **DEBUG-level logging** throughout authentication flow for troubleshooting
- Logs include:
  - Authentication method being attempted
  - Token acquisition details
  - Error codes and specific failure reasons
  - Retry attempts and fallback mechanisms

### 4. AzureCliCredentialFixed Class
- Custom Azure CLI credential handler that correctly uses `https://purview.azure.net/.default` scope
- Fixes issue where Azure SDK's internal hardcoded scope (`purview.azure.com`) was outdated
- Windows-compatible shell execution with fallback to `az.cmd`
- Robust token parsing supporting both timestamp and datetime string formats

## Bug Fixes

### Authentication Scope Correction
- **Fixed**: Purview API authentication scope was using deprecated `https://purview.azure.com` instead of `https://purview.azure.net`
- **Impact**: Users on VMs with VNet access were experiencing 403 Forbidden errors
- **Solution**: Updated to correct scope and added custom credential handler as fallback

### Token Refresh on 401 Errors
- **Fixed**: Make better distinction between 401 (auth failure) and 403 (permission failure)
- **Improved**: Token refresh logic now properly handles expired tokens

## New Files

### Documentation
- **`doc/AUTHENTICATION_TROUBLESHOOTING.md`**: Comprehensive troubleshooting guide including:
  - Common authentication errors with solutions
  - Service principal setup walkthrough
  - Azure CLI login instructions
  - Environment variable configuration guide
  - Diagnostic steps for network issues

## Improvements

### Authentication Chain
The client now uses a more robust authentication chain with better error context:
1. **Service Principal** (from environment variables)
2. **Azure CLI Credential** (with correct scope handling)
3. **DefaultAzureCredential** (managed identity, cached tokens, etc.)

Each step is logged with detailed information for debugging.

### HTTP Error Handling
- Enhanced `make_request()` method with:
  - Specific handling for 401 vs 403 errors
  - Network timeout detection and reporting
  - Connection error diagnostics
  - Automatic token refresh attempts

## Testing

All changes have been validated with:
- Service principal authentication from local machine ✅
- Azure CLI authentication from Windows PowerShell ✅
- Managed identity authentication ✅
- VNet private endpoint access ✅
- Token refresh on 401 responses ✅

## Migration Guide

### For Users
**No action required** - this is a backward-compatible release. If you encounter authentication errors, you'll now see more detailed, actionable error messages.

### For Developers
If you're catching `PurviewAuthenticationError`, you can now catch specific subclasses:

```python
try:
    client = PurviewClient(...)
except InvalidServicePrincipalError as e:
    # Service principal not registered - ask admin to run command in error message
except AzureCredentialsError as e:
    # Azure AD authentication failed - check credentials
except NetworkError as e:
    # Network connectivity issue - check firewall/DNS
except PurviewAuthenticationError as e:
    # Generic auth error
```

## Dependencies

No new dependencies added. Uses existing Azure SDK versions:
- `azure-identity>=1.12.0`
- `azure-core>=1.24.0`

## Known Issues

None at this time.

## What's Next?

- Monitor error telemetry to identify common authentication issues
- Consider adding metrics logging for authentication performance
- Plan for enhanced token caching strategies

## Contributors

Special thanks to all users who reported authentication issues in VNet environments. Your feedback helped us identify and fix the root cause.

---

**Installation:**
```bash
pip install pvw-cli==1.6.0
```

**Upgrade:**
```bash
pip install --upgrade pvw-cli
```

**Bug Reports:** https://github.com/Keayoub/pvw-cli/issues
