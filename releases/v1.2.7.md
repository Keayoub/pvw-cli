# Release v1.2.7 - Advanced Lineage Features & Column-Level Mapping

**Release Date:** November 3, 2025  
**Version:** 1.2.7  
**Previous Version:** 1.2.6

[![Version](https://img.shields.io/badge/version-1.2.7-blue.svg)](https://github.com/Keayoub/pvw-cli/releases/tag/v1.2.7)
[![Lineage](https://img.shields.io/badge/Lineage-Enhanced-green.svg)](https://github.com/Keayoub/pvw-cli)
[![Status](https://img.shields.io/badge/status-stable-success.svg)](https://github.com/Keayoub/pvw-cli)

---

## ğŸ¯ Overview

Version 1.2.7 introduces **comprehensive column-level lineage** capabilities and **UI-style direct lineage** creation, enabling users to create granular data lineage that matches Purview UI behavior. This release focuses on advanced lineage management with support for both Process-based and direct relationship lineage types.

**Key Features:**
- **Column-level lineage** with multi-target support
- **Direct lineage relationships** (UI-style, no visible Process)
- **Dual-mode CSV import** (automatic type detection)
- **Column mapping** in direct relationships
- **Enhanced error handling** and retry strategies

---

## ğŸŒŸ Highlights

### ğŸ”— Column-Level Lineage

**New CLI Commands:**

```powershell
# Create column-level lineage (Process-based)
pvw lineage create-column \
  --process-name "ETL_Product_Transform" \
  --source-table-guid "9ebbd583-4987-4d1b-b4f5-d8f6f6f60000" \
  --target-table-guids "c88126ba-5fb5-4d33-bbe2-5ff6f6f60000,52c7d566-87ab-4753-a23a-d3f6f6f60000" \
  --column-mapping "ProductID:ProductID,Name:Name"

# Create direct lineage (UI-style, no Process)
pvw lineage create-direct \
  --source-guid "9ebbd583-4987-4d1b-b4f5-d8f6f6f60000" \
  --target-guid "c88126ba-5fb5-4d33-bbe2-5ff6f6f60000" \
  --column-mapping "ProductID:ProductID,Name:Name,ProductNumber:ProductNumber"

# List column lineages
pvw lineage list-column --format table

# Delete column lineage
pvw lineage delete-column --process-guid <guid> --force
```

**Features:**
- âœ… Multi-target support (1 source â†’ N targets)
- âœ… Type validation (compatible entity types)
- âœ… Column mapping (Source:Sink pairs)
- âœ… Batch operations via CSV
- âœ… Dry-run mode with validation

---

### ğŸ“Š CSV Import Enhancements

**Dual-Mode Import:**

The `lineage import` command now automatically detects and processes two types of lineage:

1. **Process-based lineage** (traditional)
   - Creates visible Process entities (blue boxes in UI)
   - Uses `process_dataset_inputs` / `process_dataset_outputs` relationships
   - Requires Process-specific fields

2. **Direct lineage** (UI-style)
   - Creates direct relationships (gray lines in UI)
   - Uses `direct_lineage_dataset_dataset` relationship type
   - No visible Process entity
   - Matches manual lineage creation in Purview UI

**CSV Format Examples:**

```csv
# Minimal format (5 columns)
source_entity_guid,target_entity_guid,source_type,target_type,relationship_type
9ebbd583-...,c88126ba-...,azure_sql_table,azure_sql_view,direct_lineage_dataset_dataset

# With column mapping
source_entity_guid,target_entity_guid,source_type,target_type,relationship_type,column_mapping
9ebbd583-...,c88126ba-...,azure_sql_table,azure_sql_view,direct_lineage_dataset_dataset,"[{""Source"":""ProductID"",""Sink"":""ProductID""},{""Source"":""Name"",""Sink"":""Name""}]"
```

**Sample Files Provided:**
- `samples/csv/lineage_direct_simple.csv` - Minimal 5-column format
- `samples/csv/lineage_with_columns.csv` - With column mapping
- `samples/csv/lineage_example_with_columns.csv` - Comprehensive examples
- `samples/csv/lineage_columns_documented.csv` - Fully documented
- `samples/csv/lineage_mixed_example.csv` - Mixed with/without columns

---

### ğŸ¨ UI-Style Direct Lineage

**What's New:**

Direct lineage relationships now match the behavior of manually created lineage in the Purview UI:

- **Visual Representation:** Gray lines between assets (not blue Process boxes)
- **Column Mapping:** Stored in `columnMapping` attribute of relationship
- **API Endpoint:** Uses `/datamap/api/atlas/v2/relationship` endpoint
- **Relationship Type:** `direct_lineage_dataset_dataset`

**Comparison:**

| Feature | Process-based Lineage | Direct Lineage |
|---------|----------------------|----------------|
| Visual in UI | Blue Process box | Gray line |
| Relationship Type | `process_dataset_inputs` | `direct_lineage_dataset_dataset` |
| Process Entity | Visible | Hidden |
| Column Mapping | Via Process attributes | Via relationship attributes |
| Use Case | Complex ETL workflows | Simple data flows |

---

## ğŸ› Bug Fixes

### SSL/TLS Issues
- **Fixed:** Azure Front Door SSL EOF errors
- **Solution:** Implemented retry strategy with urllib3
- **Configuration:** 5 retries, exponential backoff, 60s timeout

### HTTP 400 Errors
- **Fixed:** "Request is not recognized" on lineage import
- **Solution:** Corrected endpoint from `/lineage` to `/datamap/api/atlas/v2/entity/bulk`

### Relationship Type Validation
- **Fixed:** Invalid "Produces" relationship type causing lineage invisibility
- **Solution:** Replaced with correct Atlas relationship types

---

## ğŸ”§ Technical Improvements

### Enhanced HTTP Client
```python
# Session-based retries
retry_strategy = Retry(
    total=5,
    backoff_factor=1,
    status_forcelist=[429, 500, 502, 503, 504]
)
adapter = HTTPAdapter(max_retries=retry_strategy)
session.mount("https://", adapter)
```

### Type Validation
```python
# Compatible entity type validation
COMPATIBLE_TYPES = {
    'azure_sql_table': ['azure_sql_table', 'azure_sql_view'],
    'fabric_lakehouse_table': ['fabric_lakehouse_table'],
    # ... more types
}
```

### Automatic Type Detection
```python
# CSV import automatically detects lineage type
if relationship_type == 'direct_lineage_dataset_dataset':
    # Use relationship API
    response = self._process_csv_direct_lineage(...)
else:
    # Use entity bulk API
    response = self._process_csv_lineage(...)
```

---

## ğŸ“š New Client Methods

### `_lineage.py` Additions

1. **`lineageCreateColumnLevel()`**
   - Creates column-level lineage with Process entity
   - Supports multi-target (1 source â†’ N targets)
   - Type validation and error handling

2. **`lineageCreateDirect()`**
   - Creates UI-style direct lineage
   - No visible Process entity
   - Supports column mapping in attributes

3. **`_process_csv_direct_lineage()`**
   - Processes CSV for direct relationships
   - Routes to `/relationship` endpoint
   - Handles column mapping JSON format

4. **`_are_types_compatible()`**
   - Validates source/target type compatibility
   - Prevents invalid lineage creation

---

## ğŸ“– Documentation

### New Guides
- Column-level lineage creation
- Direct vs Process-based lineage comparison
- CSV format reference with examples
- Column mapping JSON format specification

### Updated Files
- `doc/commands/lineage.md` - Complete lineage command reference
- `README.md` - Updated with new lineage features
- Multiple sample CSV files with real-world examples

---

## ğŸ§ª Validation

**Tested Scenarios:**
- âœ… Column-level lineage with single target
- âœ… Column-level lineage with multiple targets (1â†’N)
- âœ… Direct lineage without column mapping
- âœ… Direct lineage with column mapping
- âœ… CSV import with mixed lineage types
- âœ… CSV import with optional column_mapping field
- âœ… Type validation (compatible/incompatible types)
- âœ… UI display verification (Purview portal)

**Entity Types Tested:**
- `azure_sql_table` â†’ `azure_sql_table`
- `azure_sql_table` â†’ `azure_sql_view`
- `fabric_lakehouse_table` â†’ `fabric_lakehouse_table`

---

## ğŸ’¡ Use Cases

### 1. ETL Pipeline Documentation
```powershell
# Document transformation with column mapping
pvw lineage create-direct \
  --source-guid <source> \
  --target-guid <target> \
  --column-mapping "customer_id:cust_id,name:full_name,email:contact_email"
```

### 2. Bulk Lineage Import
```powershell
# Import 100+ lineage relationships with column mappings
pvw lineage import lineage_mappings.csv --dry-run
pvw lineage import lineage_mappings.csv  # Execute
```

### 3. Data Flow Visualization
```powershell
# Create simple data flows without Process overhead
pvw lineage create-direct --source-guid <A> --target-guid <B>
pvw lineage create-direct --source-guid <B> --target-guid <C>
# Result: A â†’ B â†’ C (gray lines in UI)
```

---

## ğŸ“¦ Sample Files

### New CSV Templates
| File | Purpose | Rows | Features |
|------|---------|------|----------|
| `lineage_direct_simple.csv` | Minimal format | 2 | 5 columns only |
| `lineage_with_columns.csv` | Column mapping | 2 | JSON column_mapping |
| `lineage_example_with_columns.csv` | Comprehensive | 3 | Multiple mapping scenarios |
| `lineage_columns_documented.csv` | Documented | 3 | With usage comments |
| `lineage_mixed_example.csv` | Mixed usage | 3 | With/without columns |

---

## ğŸ”„ Migration Guide

### From v1.2.6 to v1.2.7

**No Breaking Changes** - All existing functionality preserved.

**New Capabilities:**
```powershell
# OLD: Only Process-based lineage
pvw lineage create --process-name "ETL" ...

# NEW: Direct lineage (UI-style)
pvw lineage create-direct --source-guid X --target-guid Y
```

**CSV Import:**
```csv
# OLD: Only process_dataset_inputs supported
relationship_type
process_dataset_inputs

# NEW: Both types supported (auto-detected)
relationship_type
direct_lineage_dataset_dataset
```

---

## ğŸ› ï¸ Installation

### Upgrade from v1.2.6
```powershell
pip install --upgrade purview-cli
```

### Fresh Install
```powershell
pip install purview-cli==1.2.7
```

### Verify Installation
```powershell
pvw --version
# Expected: 1.2.7

pvw lineage --help
# Should show new commands: create-column, create-direct, list-column, delete-column
```

---

## ğŸ¤ Industry Validation

This implementation aligns with industry best practices for column-level lineage in Microsoft Purview:

- **Reference:** Medium article "Column Level Lineage in Microsoft Purview" (2024)
- **Approach:** Direct relationships with columnMapping attribute
- **Result:** Matches Purview UI manual lineage behavior

---

## ğŸ“‹ Known Limitations

1. **Column Mapping Display**
   - Column mappings visible in relationship details panel (click on lineage line)
   - Not displayed directly on the lineage graph

2. **Relationship Updates**
   - To update column mapping, delete and recreate the relationship
   - Purview API does not support PATCH on relationships

3. **Type Compatibility**
   - Only compatible types can be linked (enforced by validation)
   - Cross-platform lineage (e.g., SQL â†’ Fabric) requires compatible types

---

## ğŸ¯ Next Steps (v1.2.8 Roadmap)

- [ ] Lineage visualization in CLI
- [ ] Impact analysis reports
- [ ] Lineage health checks
- [ ] Bulk delete operations
- [ ] Lineage templates library

---

## ğŸ™ Acknowledgments

Special thanks to:
- Microsoft Purview documentation team
- Atlas API reference documentation
- Medium article authors for column lineage insights
- Community feedback on lineage requirements

---

## ğŸ“ Support

- **Issues:** [GitHub Issues](https://github.com/Keayoub/pvw-cli/issues)
- **Documentation:** `doc/commands/lineage.md`
- **Samples:** `samples/csv/lineage_*.csv`

---

## ğŸ“„ License

MIT License - See LICENSE file for details

---

**Full Changelog:** [v1.2.6...v1.2.7](https://github.com/Keayoub/pvw-cli/compare/v1.2.6...v1.2.7)
