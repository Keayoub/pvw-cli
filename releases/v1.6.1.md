# Release Notes - v1.6.1 (Hotfix)

**Release Date:** January 26, 2026  
**Type:** Critical Bug Fix

## Overview
v1.6.1 is a **critical hotfix** that resolves a blocking authentication issue introduced in v1.6.0. This bug prevented all authentication methods (Service Principal, Azure CLI, DefaultAzureCredential) from working correctly, resulting in HTTP 401 "Invalid token" errors.

**Severity:** CRITICAL - All users on v1.6.0 should upgrade immediately.

## Critical Bug Fixes

### Authentication Token Storage Bug (CRITICAL)
- **Issue**: Authentication tokens were never stored after being obtained, causing all API requests to fail with HTTP 401 "Invalid token"
- **Root Cause**: The `_get_authentication_token()` method returned tokens correctly, but calling code did not store the returned value in `self._token` or `self._uc_token`
- **Impact**: All authentication methods were broken:
  - ❌ Service Principal authentication (AZURE_CLIENT_ID/SECRET/TENANT_ID)
  - ❌ Azure CLI authentication (`az login`)
  - ❌ DefaultAzureCredential (Managed Identity, VS Code, etc.)
- **Fix**: 
  ```python
  # Before (broken):
  self._get_authentication_token(for_unified_catalog=False)
  token = self._token  # token was None!
  
  # After (fixed):
  self._token = self._get_authentication_token(for_unified_catalog=False)
  token = self._token  # token is now properly stored
  ```

### Token Refresh Logic Enhanced
- **Fixed**: Token refresh on HTTP 401 now forces complete re-authentication by resetting `self._credential`
- **Added**: Token validation before making requests - returns clear error if token is None
- **Improved**: Debug logging shows first 20 characters of token for troubleshooting

### User-Agent Correction
- **Fixed**: Updated User-Agent header from `purviewcli/1.5.9` to `purviewcli/1.6.1`

## Testing & Validation

All authentication scenarios verified:
- ✅ Service Principal authentication from Windows VM
- ✅ Azure CLI authentication (`az login`)
- ✅ Managed Identity authentication
- ✅ VNet private endpoint access
- ✅ Token refresh on 401 responses
- ✅ All Purview API operations (collections, glossary, entities, etc.)

## Improvements

### Enhanced Debug Logging
New debug logs added for troubleshooting:
- Token presence check before requests
- First 20 characters of token displayed (masked for security)
- API type (Purview vs Unified Catalog) clearly indicated
- Token refresh steps logged in detail

Example debug output:
```
[PURVIEWCLI DEBUG] Making PUT request to https://kaydemopurview.purview.azure.com/account/collections/test1
[PURVIEWCLI DEBUG] Using Purview API
[PURVIEWCLI DEBUG] Token (first 20 chars): eyJ0eXAiOiJKV1QiLCJ...
```

## Migration from v1.6.0

**Action Required:** Immediate upgrade recommended

```bash
# Upgrade to v1.6.1
pip install --upgrade pvw-cli
```

**No configuration changes needed** - this is a pure bug fix with no breaking changes.

## Known Issues

None at this time.

## What Changed Since v1.6.0

**Files Modified:**
- `purviewcli/client/sync_client.py`:
  - Line ~345: Fixed token storage in `make_request()` for initial auth
  - Line ~415: Fixed token storage in token refresh logic on 401
  - Line ~350: Added token validation check
  - Line ~358: Updated User-Agent to 1.6.1
  - Line ~372: Enhanced debug logging with token preview

**Commits:**
- `51cb76a4` - FIX: Token storage and refresh logic

## Service Principal Users

This release is **especially critical** for Service Principal users. The bug caused valid Service Principal credentials to fail with:
```
HTTP 401: {"error":{"code":"Unauthenticated","message":"Invalid token"}}
```

After upgrading to v1.6.1, Service Principal authentication works correctly when environment variables are set:
```bash
export AZURE_CLIENT_ID="your-client-id"
export AZURE_CLIENT_SECRET="your-client-secret"
export AZURE_TENANT_ID="your-tenant-id"
```

## Testing Checklist

Before releasing, we verified:
- [x] Service Principal authentication works
- [x] Azure CLI authentication works
- [x] Token is properly stored on initial authentication
- [x] Token is properly refreshed on 401 responses
- [x] All API endpoints return valid responses
- [x] No regression in error handling
- [x] Debug logging provides actionable information
- [x] User-Agent reflects correct version

## Release Artifacts

**Package Files:**
- `pvw_cli-1.6.1-py3-none-any.whl` (267.5 KB)
- `pvw_cli-1.6.1.tar.gz` (268.7 KB)

**Installation:**
```bash
# From PyPI
pip install pvw-cli==1.6.1

# Upgrade existing installation
pip install --upgrade pvw-cli
```

## Acknowledgments

Thank you to users who reported the authentication issue immediately after v1.6.0 release. Your quick feedback enabled us to identify and fix this critical bug within hours.

---

**Previous Release:** [v1.6.0](v1.6.0.md) - Comprehensive authentication error handling (broken - do not use)  
**Bug Report:** If you encounter issues, please file at https://github.com/Keayoub/pvw-cli/issues
